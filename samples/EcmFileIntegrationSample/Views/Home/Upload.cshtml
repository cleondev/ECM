@model UploadPageViewModel
@{
    ViewData["Title"] = "Upload tài liệu";
}

@if (!string.IsNullOrWhiteSpace(Model.Error))
{
    <div class="alert alert-danger" role="alert">
        @Model.Error
    </div>
}

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">Upload tài liệu lên ECM</div>
            <div class="card-body">
                <form asp-action="Upload" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="Form.UserEmail" class="form-label"></label>
                            <input asp-for="Form.UserEmail" class="form-control" placeholder="Email on-behalf" />
                            <span asp-validation-for="Form.UserEmail" class="text-danger"></span>
                            <div class="form-text">Email user gửi lên ECM khi upload (on-behalf).</div>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.Title" class="form-label"></label>
                            <input asp-for="Form.Title" class="form-control" placeholder="Tiêu đề hiển thị" />
                            <span asp-validation-for="Form.Title" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.DocumentTypeId" class="form-label"></label>
                            <input asp-for="Form.DocumentTypeId" class="form-control" placeholder="Tuỳ chọn" />
                            <span asp-validation-for="Form.DocumentTypeId" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Form.DocType" class="form-label"></label>
                            <input asp-for="Form.DocType" class="form-control" />
                            <span asp-validation-for="Form.DocType" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Form.Status" class="form-label"></label>
                            <input asp-for="Form.Status" class="form-control" />
                            <span asp-validation-for="Form.Status" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Form.Sensitivity" class="form-label"></label>
                            <input asp-for="Form.Sensitivity" class="form-control" />
                            <span asp-validation-for="Form.Sensitivity" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.OwnerId" class="form-label"></label>
                            <input asp-for="Form.OwnerId" class="form-control" placeholder="Để trống để lấy từ token" />
                            <span asp-validation-for="Form.OwnerId" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.CreatedBy" class="form-label"></label>
                            <input asp-for="Form.CreatedBy" class="form-control" placeholder="Để trống để lấy từ token" />
                            <span asp-validation-for="Form.CreatedBy" class="text-danger"></span>
                        </div>
                        <div class="col-12">
                            <label asp-for="Form.SelectedTagIds" class="form-label fw-semibold"></label>
                            @if (Model.Tags is { Count: > 0 })
                            {
                                <select asp-for="Form.SelectedTagIds" class="form-select" multiple size="6">
                                    @foreach (var tag in Model.Tags)
                                    {
                                        <option value="@tag.Id">@tag.Name (@(tag.NamespaceDisplayName ?? tag.NamespaceScope ?? "Không rõ namespace"))</option>
                                    }
                                </select>
                                <div class="form-text">Chọn nhiều tag để gán ngay sau khi upload (tuỳ chọn).</div>
                            }
                            else
                            {
                                <input class="form-control" value="Chưa có tag nào" disabled />
                                <div class="form-text">Tạo tag ở trang Tag để gắn vào tài liệu.</div>
                            }
                        </div>
                        <div class="col-12">
                            <label asp-for="Form.File" class="form-label fw-semibold"></label>
                            <input asp-for="Form.File" class="form-control" />
                            <span asp-validation-for="Form.File" class="text-danger"></span>
                            <div class="form-text">Chọn bất kỳ file (PDF, hình ảnh, văn bản, ...) để thử upload.</div>
                        </div>
                    </div>

                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" class="btn btn-primary">Upload</button>
                        <button type="reset" class="btn btn-outline-secondary">Làm mới</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="position-sticky" style="top: 1rem;">
            @if (Model.Result is not null)
            {
                <div class="card border-success shadow-sm mb-3">
                    <div class="card-header bg-success text-white">Upload thành công</div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Tiêu đề:</strong> @Model.Result.Document.Title</p>
                        <p class="mb-1"><strong>ID tài liệu:</strong> @Model.Result.Document.Id</p>
                        <p class="mb-1"><strong>Owner:</strong> @Model.Result.Document.OwnerId</p>
                        <p class="mb-1"><strong>Doc type:</strong> @Model.Result.Document.DocType</p>
                        <p class="mb-1"><strong>Trạng thái:</strong> @Model.Result.Document.Status</p>
                        <p class="mb-1"><strong>Độ nhạy:</strong> @Model.Result.Document.Sensitivity</p>
                        @if (Model.Result.Document.DocumentTypeId is not null)
                        {
                            <p class="mb-1"><strong>Document type ID:</strong> @Model.Result.Document.DocumentTypeId</p>
                        }
                        @if (Model.Result.Document.LatestVersion is not null)
                        {
                            <p class="mb-1"><strong>Phiên bản mới nhất:</strong> v@Model.Result.Document.LatestVersion.VersionNo (@Model.Result.Document.LatestVersion.Bytes bytes)</p>
                        }
                        @if (Model.Result.AppliedTags is { Count: > 0 })
                        {
                            <p class="mb-1"><strong>Tag đã gán:</strong> @string.Join(", ", Model.Result.AppliedTags.Select(tag => tag.Name))</p>
                        }
                        <div class="d-flex gap-2 mt-3">
                            @if (Model.Result.DownloadUri is not null)
                            {
                                <a class="btn btn-success" href="@Model.Result.DownloadUri" target="_blank" rel="noreferrer">Tải file</a>
                            }
                            <a class="btn btn-outline-primary" asp-action="DocumentDetail" asp-route-id="@Model.Result.Document.Id" target="_blank" rel="noreferrer">Xem chi tiết</a>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm">
                    <div class="card-header">Hướng dẫn nhanh</div>
                    <div class="card-body">
                        <ol class="mb-0 ps-3">
                            <li class="mb-2">Điền metadata (doc type, status, sensitivity) nếu muốn.</li>
                            <li class="mb-2">Chọn file cần upload.</li>
                            <li class="mb-0">Nhấn <strong>Upload</strong> để gửi file trực tiếp đến ECM.</li>
                        </ol>
                    </div>
                </div>
            }

            @if (Model.CurrentProfile is not null)
            {
                <div class="card mt-3 shadow-sm">
                    <div class="card-header">Thông tin người dùng từ token</div>
                    <div class="card-body">
                        <p class="mb-1 fw-semibold">@Model.CurrentProfile.DisplayName</p>
                        <p class="mb-1">Email: @Model.CurrentProfile.Email</p>
                        <p class="mb-0">User ID: @Model.CurrentProfile.Id</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
