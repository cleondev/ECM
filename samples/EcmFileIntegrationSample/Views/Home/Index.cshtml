@model UploadPageViewModel
@{
    ViewData["Title"] = "Upload tài liệu";
}

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card mb-3 shadow-sm">
            <div class="card-header">Thông tin kết nối</div>
            <div class="card-body">
                <form asp-action="SwitchUser" method="post" class="row g-2 align-items-end" asp-antiforgery="true">
                    <div class="col-md-6 col-lg-4">
                        <label class="form-label">User cấu hình</label>
                        <select name="userKey" class="form-select">
                            @foreach (var user in Model.Users)
                            {
                                <option value="@user.Key" selected="@(user.IsSelected ? "selected" : null)">@user.DisplayName</option>
                            }
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-outline-primary">Chuyển</button>
                    </div>
                </form>

                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
                    <div>
                        <div class="text-uppercase text-muted small fw-semibold">Base URL</div>
                        <div class="fs-5 fw-bold">@Model.BaseUrl</div>
                    </div>
                    <div>
                        @if (Model.UsingSsoAuthentication)
                        {
                            <div class="d-flex flex-column align-items-end">
                                <span class="badge bg-primary">On-behalf qua SSO</span>
                                <small class="text-muted">
                                    @(!string.IsNullOrWhiteSpace(Model.OnBehalfUserEmail)
                                        ? Model.OnBehalfUserEmail
                                        : Model.OnBehalfUserId?.ToString() ?? "User lấy từ token")
                                </small>
                            </div>
                        }
                        else if (Model.UsingApiKeyAuthentication)
                        {
                            <div class="d-flex flex-column align-items-end">
                                <span class="badge bg-info text-dark">auth/on-behalf qua API key</span>
                                <small class="text-muted">
                                    @(!string.IsNullOrWhiteSpace(Model.OnBehalfUserEmail)
                                        ? Model.OnBehalfUserEmail
                                        : Model.OnBehalfUserId?.ToString())
                                </small>
                            </div>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Chưa cấu hình on-behalf</span>
                        }
                    </div>
                </div>
                <p class="text-muted mb-0 mt-2">Ứng dụng hỗ trợ auth/on-behalf qua API key của AppGateway hoặc đổi token SSO thành token AppGateway (OBO). Dữ liệu tài khoản, tag và tài liệu sẽ được tải ngay khi mở trang dựa trên user đang chọn.</p>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Error))
        {
            <div class="alert alert-danger" role="alert">
                @Model.Error
            </div>
        }

        <div class="card shadow-sm">
            <div class="card-header">Upload tài liệu lên ECM</div>
            <div class="card-body">
                <form asp-action="Upload" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="Form.UserKey" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="Form.UserEmail" class="form-label"></label>
                            <input asp-for="Form.UserEmail" class="form-control" placeholder="Email on-behalf" />
                            <span asp-validation-for="Form.UserEmail" class="text-danger"></span>
                            <div class="form-text">Email user gửi lên ECM khi upload (on-behalf).</div>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.Title" class="form-label"></label>
                            <input asp-for="Form.Title" class="form-control" placeholder="Tiêu đề hiển thị" />
                            <span asp-validation-for="Form.Title" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.DocumentTypeId" class="form-label"></label>
                            <input asp-for="Form.DocumentTypeId" class="form-control" placeholder="Tuỳ chọn" />
                            <span asp-validation-for="Form.DocumentTypeId" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Form.DocType" class="form-label"></label>
                            <input asp-for="Form.DocType" class="form-control" />
                            <span asp-validation-for="Form.DocType" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Form.Status" class="form-label"></label>
                            <input asp-for="Form.Status" class="form-control" />
                            <span asp-validation-for="Form.Status" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Form.Sensitivity" class="form-label"></label>
                            <input asp-for="Form.Sensitivity" class="form-control" />
                            <span asp-validation-for="Form.Sensitivity" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.OwnerId" class="form-label"></label>
                            <input asp-for="Form.OwnerId" class="form-control" placeholder="Để trống để lấy từ token" />
                            <span asp-validation-for="Form.OwnerId" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Form.CreatedBy" class="form-label"></label>
                            <input asp-for="Form.CreatedBy" class="form-control" placeholder="Để trống để lấy từ token" />
                            <span asp-validation-for="Form.CreatedBy" class="text-danger"></span>
                        </div>
                        <div class="col-12">
                            <label asp-for="Form.SelectedTagIds" class="form-label fw-semibold"></label>
                            @if (Model.Tags is { Count: > 0 })
                            {
                                <select asp-for="Form.SelectedTagIds" class="form-select" multiple size="6">
                                    @foreach (var tag in Model.Tags)
                                    {
                                        <option value="@tag.Id">@tag.Name (@tag.NamespaceDisplayName ?? tag.NamespaceScope)</option>
                                    }
                                </select>
                                <div class="form-text">Chọn nhiều tag để gán ngay sau khi upload (tuỳ chọn).</div>
                            }
                            else
                            {
                                <input class="form-control" value="Chưa có tag nào" disabled />
                                <div class="form-text">Tạo tag trước ở phần "Quản lý tag" để gắn vào tài liệu.</div>
                            }
                        </div>
                        <div class="col-12">
                            <label asp-for="Form.File" class="form-label fw-semibold"></label>
                            <input asp-for="Form.File" class="form-control" />
                            <span asp-validation-for="Form.File" class="text-danger"></span>
                            <div class="form-text">Chọn bất kỳ file (PDF, hình ảnh, văn bản, ...) để thử upload.</div>
                        </div>
                    </div>

                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" class="btn btn-primary">Upload</button>
                        <button type="reset" class="btn btn-outline-secondary">Làm mới</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm mt-3">
            <div class="card-header">Quản lý tag</div>
            <div class="card-body">
                @if (!string.IsNullOrWhiteSpace(Model.TagMessage))
                {
                    <div class="alert alert-info" role="alert">@Model.TagMessage</div>
                }

                <h6 class="fw-semibold">Danh sách tag</h6>
                @if (Model.Tags is { Count: > 0 })
                {
                    <div class="table-responsive mb-3">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Namespace</th>
                                    <th>Parent</th>
                                    <th>Sort</th>
                                    <th>Kích hoạt</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tag in Model.Tags)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">@tag.Name</div>
                                            <small class="text-muted">@tag.Id</small>
                                        </td>
                                        <td>@tag.NamespaceDisplayName (@tag.NamespaceId)</td>
                                        <td>@tag.ParentId</td>
                                        <td>@tag.SortOrder</td>
                                        <td>
                                            @if (tag.IsActive)
                                            {
                                                <span class="badge bg-success">On</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Off</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">Chưa có tag nào.</p>
                }

                <div class="row g-4">
                    <div class="col-lg-4">
                        <h6 class="fw-semibold">Tạo mới</h6>
                        <form asp-action="CreateTag" method="post" class="needs-validation" novalidate>
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <input type="hidden" asp-for="TagCreate.UserKey" />
                            <input type="hidden" asp-for="TagCreate.UserEmail" />
                            <div class="mb-2">
                                <label asp-for="TagCreate.NamespaceId" class="form-label"></label>
                                <input asp-for="TagCreate.NamespaceId" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagCreate.ParentId" class="form-label"></label>
                                <input asp-for="TagCreate.ParentId" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagCreate.Name" class="form-label"></label>
                                <input asp-for="TagCreate.Name" class="form-control" />
                                <span asp-validation-for="TagCreate.Name" class="text-danger"></span>
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagCreate.SortOrder" class="form-label"></label>
                                <input asp-for="TagCreate.SortOrder" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagCreate.Color" class="form-label"></label>
                                <input asp-for="TagCreate.Color" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagCreate.IconKey" class="form-label"></label>
                                <input asp-for="TagCreate.IconKey" class="form-control" />
                            </div>
                            <button type="submit" class="btn btn-primary mt-2">Tạo tag</button>
                        </form>
                    </div>

                    <div class="col-lg-4">
                        <h6 class="fw-semibold">Cập nhật</h6>
                        <form asp-action="UpdateTag" method="post" class="needs-validation" novalidate>
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <input type="hidden" asp-for="TagUpdate.UserKey" />
                            <input type="hidden" asp-for="TagUpdate.UserEmail" />
                            <div class="mb-2">
                                <label asp-for="TagUpdate.TagId" class="form-label"></label>
                                <input asp-for="TagUpdate.TagId" class="form-control" />
                                <span asp-validation-for="TagUpdate.TagId" class="text-danger"></span>
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagUpdate.NamespaceId" class="form-label"></label>
                                <input asp-for="TagUpdate.NamespaceId" class="form-control" />
                                <span asp-validation-for="TagUpdate.NamespaceId" class="text-danger"></span>
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagUpdate.ParentId" class="form-label"></label>
                                <input asp-for="TagUpdate.ParentId" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagUpdate.Name" class="form-label"></label>
                                <input asp-for="TagUpdate.Name" class="form-control" />
                                <span asp-validation-for="TagUpdate.Name" class="text-danger"></span>
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagUpdate.SortOrder" class="form-label"></label>
                                <input asp-for="TagUpdate.SortOrder" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagUpdate.Color" class="form-label"></label>
                                <input asp-for="TagUpdate.Color" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="TagUpdate.IconKey" class="form-label"></label>
                                <input asp-for="TagUpdate.IconKey" class="form-control" />
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input asp-for="TagUpdate.IsActive" class="form-check-input" />
                                <label asp-for="TagUpdate.IsActive" class="form-check-label"></label>
                            </div>
                            <button type="submit" class="btn btn-warning text-white">Cập nhật tag</button>
                        </form>
                    </div>

                    <div class="col-lg-4">
                        <h6 class="fw-semibold">Xoá</h6>
                        <form asp-action="DeleteTag" method="post" class="needs-validation" novalidate>
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <input type="hidden" asp-for="TagDelete.UserKey" />
                            <input type="hidden" asp-for="TagDelete.UserEmail" />
                            <div class="mb-2">
                                <label asp-for="TagDelete.TagId" class="form-label"></label>
                                <input asp-for="TagDelete.TagId" class="form-control" />
                                <span asp-validation-for="TagDelete.TagId" class="text-danger"></span>
                            </div>
                            <button type="submit" class="btn btn-outline-danger">Xoá tag</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3">
            <div class="card-header">Quản lý tài liệu</div>
            <div class="card-body">
                @if (!string.IsNullOrWhiteSpace(Model.DocumentMessage))
                {
                    <div class="alert alert-info" role="alert">@Model.DocumentMessage</div>
                }

                <h6 class="fw-semibold">Tìm kiếm tài liệu</h6>
                <form asp-action="ListDocuments" method="post" class="row g-3 align-items-end">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="DocumentQuery.UserKey" />
                    <input type="hidden" asp-for="DocumentQuery.UserEmail" />
                    <div class="col-md-3">
                        <label asp-for="DocumentQuery.Query" class="form-label"></label>
                        <input asp-for="DocumentQuery.Query" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label asp-for="DocumentQuery.DocType" class="form-label"></label>
                        <input asp-for="DocumentQuery.DocType" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label asp-for="DocumentQuery.Status" class="form-label"></label>
                        <input asp-for="DocumentQuery.Status" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label asp-for="DocumentQuery.Sensitivity" class="form-label"></label>
                        <input asp-for="DocumentQuery.Sensitivity" class="form-control" />
                    </div>
                    <div class="col-md-1">
                        <label asp-for="DocumentQuery.Page" class="form-label"></label>
                        <input asp-for="DocumentQuery.Page" class="form-control" />
                    </div>
                    <div class="col-md-1">
                        <label asp-for="DocumentQuery.PageSize" class="form-label"></label>
                        <input asp-for="DocumentQuery.PageSize" class="form-control" />
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-outline-primary">Lọc</button>
                    </div>
                </form>

                <hr />

                <h6 class="fw-semibold">Kết quả</h6>
                @if (Model.DocumentList is { Items: { Count: > 0 } items })
                {
                    <div class="table-responsive mb-3">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Tiêu đề</th>
                                    <th>Doc type</th>
                                    <th>Status</th>
                                    <th>Độ nhạy</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var doc in items)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">@doc.Title</div>
                                            <small class="text-muted">@doc.Id</small>
                                        </td>
                                        <td>@doc.DocType</td>
                                        <td>@doc.Status</td>
                                        <td>@doc.Sensitivity</td>
                                        <td>@(doc.UpdatedAtFormatted ?? doc.UpdatedAtUtc.ToLocalTime().ToString("g"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">Chưa có tài liệu phù hợp bộ lọc.</p>
                }

                <div class="row g-4">
                    <div class="col-lg-6">
                        <h6 class="fw-semibold">Cập nhật tài liệu</h6>
                        <form asp-action="UpdateDocument" method="post" class="needs-validation" novalidate>
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <input type="hidden" asp-for="DocumentUpdate.UserKey" />
                            <input type="hidden" asp-for="DocumentUpdate.UserEmail" />
                            <div class="mb-2">
                                <label asp-for="DocumentUpdate.DocumentId" class="form-label"></label>
                                <input asp-for="DocumentUpdate.DocumentId" class="form-control" />
                                <span asp-validation-for="DocumentUpdate.DocumentId" class="text-danger"></span>
                            </div>
                            <div class="mb-2">
                                <label asp-for="DocumentUpdate.Title" class="form-label"></label>
                                <input asp-for="DocumentUpdate.Title" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="DocumentUpdate.Status" class="form-label"></label>
                                <input asp-for="DocumentUpdate.Status" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="DocumentUpdate.Sensitivity" class="form-label"></label>
                                <input asp-for="DocumentUpdate.Sensitivity" class="form-control" />
                            </div>
                            <div class="mb-2">
                                <label asp-for="DocumentUpdate.GroupId" class="form-label"></label>
                                <input asp-for="DocumentUpdate.GroupId" class="form-control" />
                                <div class="form-text">Chọn "Cập nhật Group ID" để đặt/loại bỏ giá trị này.</div>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input asp-for="DocumentUpdate.UpdateGroup" class="form-check-input" />
                                <label asp-for="DocumentUpdate.UpdateGroup" class="form-check-label"></label>
                            </div>
                            <button type="submit" class="btn btn-warning text-white">Cập nhật</button>
                        </form>
                    </div>

                    <div class="col-lg-6">
                        <h6 class="fw-semibold">Xoá tài liệu</h6>
                        <form asp-action="DeleteDocument" method="post" class="needs-validation" novalidate>
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <input type="hidden" asp-for="DocumentDelete.UserKey" />
                            <input type="hidden" asp-for="DocumentDelete.UserEmail" />
                            <div class="mb-2">
                                <label asp-for="DocumentDelete.DocumentId" class="form-label"></label>
                                <input asp-for="DocumentDelete.DocumentId" class="form-control" />
                                <span asp-validation-for="DocumentDelete.DocumentId" class="text-danger"></span>
                            </div>
                            <button type="submit" class="btn btn-outline-danger">Xoá</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="position-sticky" style="top: 1rem;">
            @if (Model.Result is not null)
            {
                <div class="card border-success shadow-sm mb-3">
                    <div class="card-header bg-success text-white">Upload thành công</div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Tiêu đề:</strong> @Model.Result.Document.Title</p>
                        <p class="mb-1"><strong>ID tài liệu:</strong> @Model.Result.Document.Id</p>
                        <p class="mb-1"><strong>Owner:</strong> @Model.Result.Document.OwnerId</p>
                        <p class="mb-1"><strong>Doc type:</strong> @Model.Result.Document.DocType</p>
                        <p class="mb-1"><strong>Trạng thái:</strong> @Model.Result.Document.Status</p>
                        <p class="mb-1"><strong>Độ nhạy:</strong> @Model.Result.Document.Sensitivity</p>
                        @if (Model.Result.Document.DocumentTypeId is not null)
                        {
                            <p class="mb-1"><strong>Document type ID:</strong> @Model.Result.Document.DocumentTypeId</p>
                        }
                        @if (Model.Result.Document.LatestVersion is not null)
                        {
                            <p class="mb-1"><strong>Phiên bản mới nhất:</strong> v@Model.Result.Document.LatestVersion.VersionNo ( @Model.Result.Document.LatestVersion.Bytes bytes)</p>
                        }
                        @if (Model.Result.AppliedTags is { Count: > 0 })
                        {
                            <p class="mb-1"><strong>Tag đã gán:</strong> @string.Join(", ", Model.Result.AppliedTags.Select(tag => tag.Name))</p>
                        }
                        @if (Model.Result.DownloadUri is not null)
                        {
                            <a class="btn btn-success mt-2" href="@Model.Result.DownloadUri" target="_blank" rel="noreferrer">Tải file</a>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm">
                    <div class="card-header">Hướng dẫn nhanh</div>
                    <div class="card-body">
                        <ol class="mb-0 ps-3">
                            <li class="mb-2">Điền metadata (doc type, status, sensitivity) nếu muốn.</li>
                            <li class="mb-2">Chọn file cần upload.</li>
                            <li class="mb-0">Nhấn <strong>Upload</strong> để gửi file trực tiếp đến ECM.</li>
                        </ol>
                    </div>
                </div>
            }

            @if (Model.CurrentProfile is not null)
            {
                <div class="card mt-3 shadow-sm">
                    <div class="card-header">Thông tin người dùng từ token</div>
                    <div class="card-body">
                        <p class="mb-1 fw-semibold">@Model.CurrentProfile.DisplayName</p>
                        <p class="mb-1">Email: @Model.CurrentProfile.Email</p>
                        <p class="mb-0">User ID: @Model.CurrentProfile.Id</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
