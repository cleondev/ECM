<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Azure SSO Control Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: dark;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --bg-gradient: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.35), transparent 55%),
                             radial-gradient(circle at 80% 0%, rgba(236, 72, 153, 0.35), transparent 45%),
                             linear-gradient(135deg, #050816 0%, #0b1c2c 40%, #020617 100%);
            --panel-bg: rgba(10, 22, 40, 0.8);
            --panel-border: rgba(56, 189, 248, 0.35);
            --accent: #38bdf8;
            --accent-strong: #f472b6;
            --azure: #0078d4;
            color: #e0f2fe;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(1.5rem, 5vw, 4rem);
        }

        .grid-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: linear-gradient(rgba(56, 189, 248, 0.06) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(56, 189, 248, 0.06) 1px, transparent 1px);
            background-size: 80px 80px;
            mix-blend-mode: screen;
            opacity: 0.65;
            transform: perspective(1200px) rotateX(58deg) translateY(10%);
        }

        main {
            position: relative;
            width: min(960px, 100%);
            backdrop-filter: blur(18px);
            background: var(--panel-bg);
            border-radius: 24px;
            border: 1px solid var(--panel-border);
            box-shadow: 0 30px 100px rgba(15, 118, 210, 0.25);
            padding: clamp(2rem, 5vw, 3.75rem);
            overflow: hidden;
        }

        main::before {
            content: "";
            position: absolute;
            inset: -80px;
            background: conic-gradient(from 180deg at 50% 50%, rgba(56, 189, 248, 0.12), transparent 35%, rgba(244, 114, 182, 0.12));
            filter: blur(80px);
            z-index: 0;
        }

        header {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: clamp(2rem, 4vw, 3rem);
        }

        header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 4vw, 3rem);
            margin: 0;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--accent);
            text-shadow: 0 0 18px rgba(56, 189, 248, 0.45);
        }

        header p {
            margin: 0;
            color: rgba(224, 242, 254, 0.78);
            max-width: 720px;
            line-height: 1.6;
        }

        .content {
            position: relative;
            z-index: 1;
            display: grid;
            gap: clamp(1.75rem, 4vw, 2.5rem);
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .card {
            background: rgba(8, 21, 37, 0.9);
            border-radius: 20px;
            padding: 1.75rem;
            border: 1px solid rgba(56, 189, 248, 0.15);
            box-shadow: inset 0 0 24px rgba(14, 165, 233, 0.08);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .card h2 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            font-size: 1.25rem;
            letter-spacing: 0.08em;
            color: var(--accent-strong);
            text-transform: uppercase;
        }

        .steps {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 0.75rem;
        }

        .steps li {
            position: relative;
            padding-left: 1.5rem;
            line-height: 1.6;
            color: rgba(224, 242, 254, 0.82);
        }

        .steps li::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.6rem;
            width: 0.6rem;
            height: 0.6rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            box-shadow: 0 0 12px rgba(56, 189, 248, 0.6);
        }

        label {
            font-size: 0.9rem;
            color: rgba(224, 242, 254, 0.72);
        }

        input, select {
            width: 100%;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            border: 1px solid rgba(56, 189, 248, 0.35);
            background: rgba(2, 6, 23, 0.65);
            color: #f8fafc;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
        }

        button {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.9rem 1.4rem;
            border-radius: 12px;
            border: 1px solid rgba(56, 189, 248, 0.45);
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.15), rgba(244, 114, 182, 0.15));
            color: #f1f5f9;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        button::after {
            content: "";
            position: absolute;
            inset: 2px;
            border-radius: 10px;
            border: 1px solid rgba(56, 189, 248, 0.35);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(14, 165, 233, 0.2);
            border-color: rgba(244, 114, 182, 0.45);
        }

        button:hover::after {
            opacity: 1;
        }

        button.primary {
            background: linear-gradient(135deg, var(--azure), #9333ea);
            border: none;
        }

        button.primary:hover {
            box-shadow: 0 18px 35px rgba(59, 130, 246, 0.35);
        }

        .output {
            min-height: 160px;
            border-radius: 16px;
            border: 1px solid rgba(56, 189, 248, 0.35);
            background: rgba(2, 6, 23, 0.7);
            padding: 1.25rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.7;
            color: rgba(148, 163, 184, 0.95);
            overflow: auto;
            white-space: pre-wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            background: rgba(56, 189, 248, 0.12);
            color: var(--accent);
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        @media (max-width: 720px) {
            main {
                padding: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="grid-bg" aria-hidden="true"></div>
    <main>
        <header>
            <span class="badge">Azure Active Directory · SSO</span>
            <h1>Azure SSO Control Center</h1>
            <p>
                Trang điều phối đăng nhập một lần (Single Sign-On) cho hệ thống ECM. Hãy nhập thông tin cấu hình của ứng dụng
                để tạo đường dẫn ủy quyền và theo dõi trạng thái phiên đăng nhập thông qua Azure Active Directory.
            </p>
        </header>
        <div class="content">
            <section class="card">
                <h2>Quy trình xác thực</h2>
                <ul class="steps">
                    <li>Thiết lập Tenant ID, Client ID và URL chuyển hướng trùng khớp với cấu hình trong Azure Portal.</li>
                    <li>Tạo đường dẫn ủy quyền và chuyển hướng người dùng sang trang đăng nhập của Microsoft.</li>
                    <li>Nhận mã ủy quyền (authorization code) tại redirect URI, gửi về backend để đổi access token.</li>
                    <li>Lưu phiên đăng nhập và tiếp tục điều hướng người dùng vào không gian làm việc ECM.</li>
                </ul>
            </section>
            <section class="card">
                <h2>Cấu hình phiên SSO</h2>
                <form id="sso-form">
                    <div>
                        <label for="tenantId">Tenant ID</label>
                        <input id="tenantId" name="tenantId" type="text" placeholder="vd: contoso.onmicrosoft.com hoặc GUID" required />
                    </div>
                    <div>
                        <label for="clientId">Client ID (Ứng dụng)</label>
                        <input id="clientId" name="clientId" type="text" placeholder="Application (client) ID" required />
                    </div>
                    <div>
                        <label for="redirectUri">Redirect URI</label>
                        <input id="redirectUri" name="redirectUri" type="url" placeholder="https://ecm.example.com/auth/callback" required />
                    </div>
                    <div>
                        <label for="scope">Scope</label>
                        <input id="scope" name="scope" type="text" value="openid profile email offline_access" />
                    </div>
                    <div>
                        <label for="responseMode">Response mode</label>
                        <select id="responseMode" name="responseMode">
                            <option value="query">query</option>
                            <option value="form_post">form_post</option>
                            <option value="fragment">fragment</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:0.75rem; margin-top:0.5rem;">
                        <button type="button" class="primary" id="generate-url">Tạo URL đăng nhập</button>
                        <button type="submit">Ghi nhận phiên với backend</button>
                    </div>
                </form>
            </section>
            <section class="card">
                <h2>Console realtime</h2>
                <div id="output" class="output">Chưa khởi tạo thao tác nào...</div>
            </section>
        </div>
    </main>

    <script>
        const form = document.getElementById('sso-form');
        const output = document.getElementById('output');
        const generateUrlBtn = document.getElementById('generate-url');

        const renderMessage = (title, payload) => {
            const timestamp = new Date().toLocaleTimeString();
            const message = {
                timestamp,
                title,
                ...payload
            };
            output.textContent = JSON.stringify(message, null, 2);
        };

        const buildAuthorizeUrl = ({ tenantId, clientId, redirectUri, scope, responseMode }) => {
            const params = new URLSearchParams({
                client_id: clientId,
                response_type: 'code',
                redirect_uri: redirectUri,
                response_mode: responseMode,
                scope,
                prompt: 'select_account'
            });
            return `https://login.microsoftonline.com/${encodeURIComponent(tenantId)}/oauth2/v2.0/authorize?${params.toString()}`;
        };

        generateUrlBtn.addEventListener('click', () => {
            const formData = new FormData(form);
            const tenantId = formData.get('tenantId').trim();
            const clientId = formData.get('clientId').trim();
            const redirectUri = formData.get('redirectUri').trim();
            const scope = formData.get('scope').trim();
            const responseMode = formData.get('responseMode');

            if (!tenantId || !clientId || !redirectUri) {
                renderMessage('Thiếu cấu hình', { details: 'Vui lòng nhập đủ Tenant ID, Client ID và Redirect URI.' });
                return;
            }

            const url = buildAuthorizeUrl({ tenantId, clientId, redirectUri, scope, responseMode });
            renderMessage('Đường dẫn ủy quyền đã tạo', { authorizeUrl: url });
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/auth/azure/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Không thể ghi nhận phiên SSO.');
                }

                const result = await response.json();
                renderMessage('Đã ghi nhận cấu hình SSO', result);
            } catch (error) {
                renderMessage('Lỗi kết nối backend', { message: error.message });
            }
        });
    </script>
</body>
</html>
